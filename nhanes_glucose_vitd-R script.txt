############################################################
# Title: Vitamin D and Fasting Glucose Analysis in NHANES (2011–2018)
# Author: Abrham Azale
# Date: 2025
#
# Description:
#   This script:
#     1. Imports the prepared NHANES dataset (nhanes_all.csv)
#     2. Creates analysis variables (fasting glucose categories, predictors)
#     3. Defines the complex NHANES survey design
#     4. Checks key model assumptions:
#          4a. Proportional-odds assumption (Brant test, unweighted)
#          4b. Multicollinearity (VIF, unweighted)
#          4c. Influential observations (Cook's distance, leverage)
#     5. Fits a survey-weighted ordinal logistic regression model (svyolr)
#     6. Saves model summary, odds ratios, and diagnostics to a text file
#
#   This corresponds to my ADA final project and is written to be
#   transparent and fully reproducible.
############################################################

## 0. Packages --------------------------------------------------------------

# Data manipulation and I/O
library(tidyverse)   # dplyr, readr, etc.

# Complex survey analysis
library(survey)      # svydesign, svyolr

# Optional: proportional-odds assumption check (unweighted)
library(MASS)        # polr()
library(brant)       # brant()

# Optional: multicollinearity diagnostics
library(car)         # vif()

# Optional: handle lonely PSUs (commonly recommended)
# options(survey.lonely.psu = "adjust")


## 1. Import data -----------------------------------------------------------

# Assumes "nhanes_all.csv" is in the current working directory.
# (Use getwd() to check or setwd() to change if necessary.)
df <- read_csv("nhanes_all.csv")

# Quick sanity checks (can be commented out later)
names(df)             # variable names
summary(df$LBXVIDMS)  # vitamin D
summary(df$LBXGLU)    # fasting glucose


## 2. Create analysis variables --------------------------------------------

df <- df %>%
  mutate(
    # Fasting glucose categories: Normal, Impaired, Diabetic
    glu_cat = case_when(
      LBXGLU < 100 ~ "Normal",
      LBXGLU >= 100 & LBXGLU <= 125 ~ "Impaired",
      LBXGLU >= 126 ~ "Diabetic",
      TRUE ~ NA_character_
    ),
    glu_cat = factor(
      glu_cat,
      levels = c("Normal", "Impaired", "Diabetic"),
      ordered = TRUE
    ),

    # Continuous predictors
    vitd = LBXVIDMS,
    age  = RIDAGEYR,

    # Sex as factor
    sex  = factor(RIAGENDR, labels = c("Male", "Female")),

    # Race/ethnicity recode
    race = case_when(
      RIDRETH3 %in% c(1, "1", "Mexican American") ~ "Mexican American",
      RIDRETH3 %in% c(2, "2", "Other Hispanic") ~ "Other Hispanic",
      RIDRETH3 %in% c(3, "3", "Non-Hispanic White") ~ "Non-Hispanic White",
      RIDRETH3 %in% c(4, "4", "Non-Hispanic Black") ~ "Non-Hispanic Black",
      RIDRETH3 %in% c(6, "6", "Non-Hispanic Asian") ~ "Non-Hispanic Asian",
      RIDRETH3 %in% c(7, "7",
                      "Other Race - Including Multi-Racial",
                      "Other/Multi-Racial") ~ "Other/Multi-Racial",
      TRUE ~ NA_character_
    ),
    race = factor(
      race,
      levels = c(
        "Mexican American",
        "Other Hispanic",
        "Non-Hispanic White",
        "Non-Hispanic Black",
        "Non-Hispanic Asian",
        "Other/Multi-Racial"
      )
    )
  )


## 3. Define survey design --------------------------------------------------

# Define NHANES survey design using MEC exam weights
#   id      : SDMVPSU  (primary sampling units)
#   strata  : SDMVSTRA (strata)
#   weights : WTMEC2YR (MEC exam weights for lab measures)
nhanes_svy <- svydesign(
  id      = ~SDMVPSU,
  strata  = ~SDMVSTRA,
  weights = ~WTMEC2YR,
  nest    = TRUE,
  data    = df
)

# Rationale:
#   Both serum vitamin D and fasting glucose are measured in the MEC exam
#   component; using WTMEC2YR yields nationally representative estimates.


## 4. MODEL ASSUMPTION CHECKS ----------------------------------------------

## 4a. Proportional-odds assumption (Brant test, unweighted) ---------------

# Create complete-case dataset (base R — avoids select() conflict)
po_data <- df[, c("glu_cat", "vitd", "age", "sex", "race")]
po_data <- po_data[complete.cases(po_data), ]

# Fit an unweighted ordinal logistic regression (polr)
po_fit <- polr(
  glu_cat ~ vitd + age + sex + race,
  data = po_data,
  Hess = TRUE
)

# Brant test for proportional-odds assumption
po_brant <- brant(po_fit)
po_brant

# Interpretation (for write-up):
#   - Non-significant global and variable-specific Brant tests suggest
#     that the proportional-odds assumption is reasonably met.
#   - Significant results can be discussed as a limitation, noting that
#     the primary model is survey-weighted (svyolr) but the Brant test
#     is unweighted.


## 4b. Multicollinearity (VIF, unweighted) ---------------------------------

# Use an unweighted linear model with the same predictors to assess VIF.
# Collinearity is a property of the predictors themselves, so this provides
# a reasonable diagnostic even without survey weights.

vif_fit <- lm(
  as.numeric(glu_cat) ~ vitd + age + sex + race,
  data = po_data
)

vif_results <- car::vif(vif_fit)
vif_results

# Interpretation (for write-up):
#   - VIF values < 3 (or even < 5) are typically interpreted as indicating
#     no serious multicollinearity concerns among predictors.


## 4c. Influential observations (Cook's distance, leverage) -----------------

# Use the same unweighted linear model (vif_fit) to assess influence.
# We examine Cook's distance and leverage (hat values) to identify
# potentially influential cases.

cook_vals <- cooks.distance(vif_fit)
hat_vals  <- hatvalues(vif_fit)

n_obs <- nrow(po_data)
p_par <- length(coef(vif_fit))

# Common rule-of-thumb cutoffs
cook_cutoff <- 4 / n_obs
hat_cutoff  <- 2 * p_par / n_obs

infl_flags <- (cook_vals > cook_cutoff) | (hat_vals > hat_cutoff)

influential_summary <- list(
  n_observations              = n_obs,
  n_parameters                = p_par,
  cook_cutoff                 = cook_cutoff,
  hat_cutoff                  = hat_cutoff,
  n_potentially_influential   = sum(infl_flags),
  proportion_influential      = mean(infl_flags)
)

# Optionally, inspect the first few influential indices:
potentially_influential_indices <- which(infl_flags)
head(potentially_influential_indices)


## 5. Survey-weighted ordinal regression -----------------------------------

# Survey-weighted proportional-odds ordinal logistic regression
model_ord <- svyolr(
  glu_cat ~ vitd + age + sex + race,
  design = nhanes_svy
)

summary(model_ord)

# Exponentiate coefficients to obtain common odds ratios
ord_coef <- coef(model_ord)
ord_or   <- exp(ord_coef)
ord_ci   <- exp(confint(model_ord))

ord_results <- cbind(
  OR  = ord_or,
  LCL = ord_ci[, 1],
  UCL = ord_ci[, 2]
)
ord_results


## 6. Save Outputs ----------------------------------------------------------

# Create output directory if it does not already exist
if (!dir.exists("output")) dir.create("output")

sink("output/model_results_ordinal.txt")

cat("=== Survey-weighted Ordinal Regression (svyolr) ===\n\n")
print(summary(model_ord))

cat("\n\nExponentiated Coefficients (OR) and 95% CI:\n\n")
print(ord_results)

cat("\n\n=== 4a. Proportional-odds Assumption (Brant Test, Unweighted) ===\n\n")
print(po_brant)

cat("\n\n=== 4b. Multicollinearity Diagnostics (VIF, Unweighted Linear Model) ===\n\n")
print(vif_results)

cat("\n\n=== 4c. Influential Observations (Cook's Distance & Leverage) ===\n\n")
print(influential_summary)

sink()  # close sink


# End of script
############################################################
